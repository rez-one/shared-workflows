name: Build and Test Quality Gate
on:
  workflow_call:
    secrets:
      SSH_JUMP_HOST_USER:
        required: true
      SSH_JUMP_HOST_KEY:
        required: true
      SSH_JUMP_HOST_IP:
        required: true
      GCR_CREDENTIALS:
        required: true
      NEXUS_USERNAME:
        required: false
      NEXUS_PASSWORD:
        required: false
    inputs:
      branchesToPublishArtifacts:
        description: 'Branches To Publish Artifacts'
        required: false
        default: '["dev", "qa", "test", "uat", "main", "master"]'
        type: string
      branchesToPublishImages:
        description: 'Branches To Publish Docker Images to GCR'
        required: false
        default: '["dev", "qa", "test", "uat", "main", "master"]'
        type: string

jobs:
  build-and-test:
    name: Build and Test Quality Gate Job
    runs-on: ubuntu-latest
    env:
      ORG_GRADLE_PROJECT_nexusUsername: ${{ secrets.NEXUS_USERNAME }}
      ORG_GRADLE_PROJECT_nexusPassword: ${{ secrets.NEXUS_PASSWORD }}
    steps:
      - name: Extract branch name and commit hash
        shell: bash
        run: |
          if [[ ${{ github.event_name }} == 'pull_request' ]]; then
            echo "##[set-output name=short_sha;]$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)"
            echo "##[set-output name=branch_name;]$(echo ${GITHUB_HEAD_REF#refs/heads/})"
          else
            echo "##[set-output name=short_sha;]$(echo ${{ github.sha }} | cut -c1-7)"
            echo "##[set-output name=branch_name;]$(echo ${GITHUB_REF#refs/heads/})"
          fi          
        id: extract_git_branch_info

      - run: echo "ðŸŽ‰ The job was automatically triggered for the commit ${{ steps.extract_git_branch_info.outputs.short_sha }} in branch ${{ steps.extract_git_branch_info.outputs.branch_name }} by a ${{ github.event_name }} event."
      - run: echo "ðŸŽ‰ github.ref ${{ github.ref}}  github.ref_name ${{ github.ref_name}}"

